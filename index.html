<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE FORGE - æ——èˆ°ç‰ˆ</title>
    <style>
        /* === 1. æ ¸å¿ƒè§†è§‰ç³»ç»Ÿ === */
        :root {
            --bg: #121212; --sidebar: #181818; --card: #1e1e1e;
            --text: #e0e0e0; --sub-text: #a0a0a0;
            --accent: #bb86fc; --success: #03dac6; --danger: #cf6679; --info: #2196f3;
            --border: #333; --shadow: rgba(0,0,0,0.5);
        }
        body.light-mode {
            --bg: #f0f2f5; --sidebar: #ffffff; --card: #ffffff;
            --text: #333333; --sub-text: #666666;
            --accent: #6200ee; --success: #018786; --danger: #b00020; --info: #0288d1;
            --border: #ddd; --shadow: rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 240px 1fr 280px; overflow: hidden; transition: 0.3s; }

        /* === æ‰‹æœºç«¯é€‚é… === */
        @media (max-width: 768px) {
            body { grid-template-columns: 1fr; grid-template-rows: 60px 1fr 0px; }
            .sidebar {
                flex-direction: row !important; position: fixed; bottom: 0; width: 100%; height: 60px;
                border-top: 1px solid var(--border); border-right: none !important; padding: 0 !important;
                justify-content: space-around; z-index: 100; overflow-x: auto; /* å…è®¸æ¨ªå‘æ»šåŠ¨ä»¥å®¹çº³æ›´å¤šæŒ‰é’® */
            }
            .sidebar .logo { display: none; }
            .nav-item { flex-direction: column; font-size: 10px; padding: 5px 10px !important; gap: 2px !important; min-width: 60px; justify-content: center; }
            .nav-text { display: block !important; }
            
            .stats-panel { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; z-index: 150; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
            .stats-panel.open { right: 0; }
            .mobile-header { display: flex !important; }
            .card-container { height: 400px !important; margin-top: 10px; }
            .word-text { font-size: 38px !important; }
        }

        .mobile-header { display: none; justify-content: space-between; align-items: center; padding: 0 20px; background: var(--sidebar); border-bottom: 1px solid var(--border); z-index: 50; }

        /* === ä¾§è¾¹æ  === */
        .sidebar { background-color: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .logo { font-size: 20px; font-weight: bold; color: var(--accent); letter-spacing: 1px; margin-bottom: 15px; cursor: pointer;}
        .nav-item { padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: var(--sub-text); display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: var(--bg); color: var(--text); }
        .nav-icon { font-size: 18px; }

        /* === ä¸»åŒºåŸŸ === */
        .main-area { position: relative; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; padding-bottom: 80px; }
        .page-section { display: none; padding: 20px; min-height: 100%; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .page-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å¡ç‰‡ç³»ç»Ÿ */
        .card-container { width: 100%; max-width: 500px; height: 450px; perspective: 1000px; cursor: pointer; margin-bottom: 20px; position: relative;}
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.5s; transform-style: preserve-3d; box-shadow: 0 10px 30px var(--shadow); border-radius: 20px; }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background-color: var(--card); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; border: 1px solid var(--border); }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; padding-top: 30px; }
        
        .word-text { font-size: 46px; font-weight: bold; margin-bottom: 10px; color: var(--text); }
        .phonetic { font-family: 'Times New Roman', serif; font-size: 18px; color: var(--accent); margin-bottom: 15px; }
        .meaning { font-size: 18px; margin-bottom: 15px; color: var(--success); line-height: 1.5; width: 100%; max-height: 100px; overflow-y: auto;}
        .sentence { font-style: italic; color: var(--sub-text); margin: 10px 0; padding: 12px; background: var(--bg); border-radius: 10px; width: 100%; text-align: left; border-left: 3px solid var(--accent); font-size: 14px; max-height: 80px; overflow-y: auto;}

        /* æ·±åº¦æœç´¢æŒ‰é’®ç»„ */
        .search-links { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: auto; width: 100%; }
        .link-btn { font-size: 12px; padding: 6px 10px; border-radius: 15px; background: var(--bg); border: 1px solid var(--border); color: var(--sub-text); text-decoration: none; transition: 0.2s; }
        .link-btn:hover { border-color: var(--accent); color: var(--accent); }

        .controls { display: flex; gap: 15px; width: 100%; max-width: 500px; margin-bottom: 20px; }
        .btn-control { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; color: #fff; transition: 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-control:active { transform: scale(0.95); }

        /* é”™é¢˜æœ¬ */
        .list-container { width: 100%; max-width: 600px; display: grid; gap: 10px; }
        .list-item { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-mini { padding: 5px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin-left: 5px; color: white; }

        /* é¢˜å‹é€šç”¨æ ·å¼ (Quiz & Cloze) */
        .quiz-container { width: 100%; max-width: 500px; text-align: center; }
        .quiz-question { font-size: 24px; color: var(--text); margin-bottom: 30px; line-height: 1.5; }
        .quiz-options { display: grid; gap: 15px; }
        .quiz-btn { padding: 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 10px; cursor: pointer; font-size: 16px; text-align: left; transition: 0.2s; }
        .quiz-btn:hover { border-color: var(--accent); background: var(--bg); }
        .quiz-btn.correct { background: var(--success); color: black; border-color: var(--success); }
        .quiz-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        .cloze-blank { border-bottom: 2px solid var(--accent); color: var(--accent); font-weight: bold; padding: 0 5px; }

        /* å³ä¾§é¢æ¿ */
        .stats-panel { background-color: var(--sidebar); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;}
        .stat-card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-val { font-size: 24px; font-weight: bold; margin-top: 5px; color: var(--text); }
        
        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 90%; max-width: 400px; border-radius: 15px; padding: 25px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; text-align: center;}
        .book-btn { display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px; text-align: left; cursor: pointer; font-size: 16px; font-weight: 600; }

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300; }
        .toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>

    <!-- æ‰‹æœºé¡¶éƒ¨ -->
    <div class="mobile-header">
        <div class="logo">âš¡ THE FORGE</div>
        <div style="font-size: 24px; cursor: pointer;" onclick="toggleStats()">ğŸ“Š</div>
    </div>

    <!-- é€‰ä¹¦å¼¹çª— -->
    <div class="modal-overlay" id="book-modal">
        <div class="modal-content">
            <h2 style="color:var(--text); margin-bottom: 20px;">ğŸ“š é€‰æ‹©ä¸€æœ¬è¯ä¹¦</h2>
            <div id="book-list"><p style="color:red">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</p></div>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <div class="sidebar">
        <div class="logo desktop-only">âš¡ THE FORGE</div>
        <div class="nav-item active" onclick="switchTab('learn')"><span class="nav-icon">ğŸ </span><span class="nav-text">èƒŒå•è¯</span></div>
        <div class="nav-item" onclick="switchTab('wrong')"><span class="nav-icon">ğŸ““</span><span class="nav-text">é”™é¢˜æœ¬</span></div>
        <div class="nav-item" onclick="switchTab('quiz')"><span class="nav-icon">ğŸ¯</span><span class="nav-text">é€‰è¯</span></div>
        <div class="nav-item" onclick="switchTab('cloze')"><span class="nav-icon">ğŸ§©</span><span class="nav-text">å¡«ç©º</span></div>
        <div class="nav-item" onclick="toggleTheme()"><span class="nav-icon">â˜€ï¸</span><span class="nav-text">ä¸»é¢˜</span></div>
        <div class="nav-item" onclick="resetProgress()"><span class="nav-icon">ğŸ”„</span><span class="nav-text">æ¢ä¹¦</span></div>
    </div>

    <!-- ä¸»åŒºåŸŸ -->
    <div class="main-area">
        
        <!-- 1. èƒŒè¯æ¨¡å¼ -->
        <div id="section-learn" class="page-section active">
            <div style="margin-bottom: 10px; color: var(--sub-text); font-size: 14px;">
                <span id="learn-mode-tag" style="background:var(--accent); color:black; padding:2px 6px; border-radius:4px; font-size:10px; vertical-align:middle; display:none">å¤ä¹ ä¸­</span>
                å½“å‰è¯ä¹¦: <span id="current-book-name" style="color:var(--accent); font-weight:bold">æœªé€‰æ‹©</span>
            </div>
            
            <div class="card-container" onclick="flipCard()">
                <div class="card-inner">
                    <div class="card-face card-front">
                        <div class="word-text" id="card-word">Loading...</div>
                        <div class="phonetic" id="card-phonetic"> </div>
                        <button onclick="event.stopPropagation(); playAudio()" style="background:none; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:20px; cursor:pointer;">ğŸ”Š å‘éŸ³</button>
                        <div style="margin-top:auto; font-size: 12px; color: var(--sub-text);">(ç‚¹å‡»æŸ¥çœ‹èƒŒé¢)</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="meaning" id="card-meaning">...</div>
                        <div class="sentence" id="card-sentence">...</div>
                        
                        <!-- æ–°å¢ï¼šæ·±åº¦å­¦ä¹ åŒº -->
                        <div style="margin-top:auto; width:100%">
                            <div style="font-size:10px; color:var(--sub-text); margin-bottom:5px">ğŸ” åœ¨çº¿æ·±åº¦å­¦ä¹ </div>
                            <div class="search-links">
                                <a href="#" onclick="openSearch(event, 'etym')" class="link-btn">ğŸŒ± è¯æ ¹è¯ç¼€</a>
                                <a href="#" onclick="openSearch(event, 'cambridge')" class="link-btn">ğŸ‡¬ğŸ‡§ å‰‘æ¡¥(æ­é…)</a>
                                <a href="#" onclick="openSearch(event, 'thesaurus')" class="link-btn">ğŸ”— è¿‘ä¹‰è¯</a>
                                <a href="#" onclick="openSearch(event, 'bing')" class="link-btn">ğŸ–¼ï¸ å›¾ç‰‡</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn-control" style="background:var(--danger)" onclick="rateWord(0)">ğŸ˜© è®°ä¸ä½</button>
                <button class="btn-control" style="background:var(--success)" onclick="rateWord(1)">ğŸ˜ è®°ä½äº†</button>
            </div>
        </div>

        <!-- 2. é”™é¢˜æœ¬ -->
        <div id="section-wrong" class="page-section">
            <h2 style="color:var(--text); margin-bottom: 20px;">ğŸ““ é”™é¢˜æœ¬</h2>
            <div style="display:flex; gap:10px; margin-bottom: 20px; flex-wrap:wrap; justify-content:center;">
                <button class="btn-mini" style="background:var(--accent); padding:10px 20px;" onclick="startMistakeReview()">ğŸš€ æ¨¡å¼ï¼šåªèƒŒé”™é¢˜</button>
                <button class="btn-mini" style="background:var(--info); padding:10px 20px;" onclick="exportPDF()">ğŸ–¨ï¸ æ‰“å°PDF</button>
                <button class="btn-mini" style="background:var(--danger); padding:10px 20px;" onclick="clearWrongBook()">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
            <div class="list-container" id="wrong-container"></div>
        </div>

        <!-- 3. é€‰è¯æµ‹è¯• (Quiz) -->
        <div id="section-quiz" class="page-section">
            <h2 style="margin-bottom:20px; color:var(--sub-text)">ğŸ¯ é€‰è¯æµ‹è¯• (4é€‰1)</h2>
            <div class="quiz-container">
                <div class="quiz-question" id="quiz-word" style="font-size:40px; font-weight:bold; margin-bottom:40px">Word</div>
                <div class="quiz-options" id="quiz-options">
                    <!-- é€‰é¡¹ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- 4. å®Œå½¢å¡«ç©º (Cloze) -->
        <div id="section-cloze" class="page-section">
            <h2 style="margin-bottom:20px; color:var(--sub-text)">ğŸ§© çœŸé¢˜è¯­å¢ƒå¡«ç©º</h2>
            <div class="quiz-container">
                <div class="quiz-question" id="cloze-sentence" style="font-size:20px; text-align:left; background:var(--card); padding:20px; border-radius:10px; border:1px solid var(--border)">
                    Thinking is the hardest work there is, which is probably the reason why so few engage in it.
                </div>
                <div style="margin:20px 0; color:var(--sub-text)">è¯·é€‰æ‹©ç¼ºå¤±çš„å•è¯ï¼š</div>
                <div class="quiz-options" id="cloze-options">
                    <!-- é€‰é¡¹ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </div>

    </div>

    <!-- å³ä¾§é¢æ¿ -->
    <div class="stats-panel" id="stats-panel">
        <div style="display: flex; justify-content: space-between;">
            <h3 style="color:var(--text)">å­¦ä¹ è¿›åº¦</h3>
            <span style="font-size: 24px; cursor: pointer;" onclick="toggleStats()">âœ•</span>
        </div>
        <div class="stat-card">
            <div style="font-size: 12px; color: var(--sub-text);">å½“å‰è¿›åº¦</div>
            <div class="stat-val" id="progress-display">0 / 0</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 12px; color: var(--sub-text);">é”™é¢˜ç§¯ç´¯</div>
            <div class="stat-val" style="color: var(--danger)" id="wrong-count">0</div>
        </div>
    </div>

    <div class="toast" id="toast">æç¤º</div>

    <script>
        // === 1. é…ç½®è·¯å¾„ (é€‚é… GitHub Pages) ===
        const books = [
            { name: "åˆä¸­è¯æ±‡", file: "json/1-åˆä¸­-é¡ºåº.json" },
            { name: "é«˜ä¸­è¯æ±‡", file: "json/2-é«˜ä¸­-é¡ºåº.json" },
            { name: "å››çº§è¯æ±‡", file: "json/3-CET4-é¡ºåº.json" },
            { name: "å…­çº§è¯æ±‡", file: "json/4-CET6-é¡ºåº.json" },
            { name: "è€ƒç ”è¯æ±‡", file: "json/5-è€ƒç ”-é¡ºåº.json" },
            { name: "æ‰˜ç¦è¯æ±‡", file: "json/6-æ‰˜ç¦-é¡ºåº.json" },
            { name: "SATè¯æ±‡", file: "json/7-SAT-é¡ºåº.json" }
        ];

        // å…¨å±€å˜é‡
        let wordQueue = []; // å½“å‰èƒŒè¯µé˜Ÿåˆ—
        let mainQueue = []; // ä¸»è¯åº“å¤‡ä»½
        let currentIndex = 0;
        let currentBookName = "";
        let wrongWords = JSON.parse(localStorage.getItem('forge_wrong_words')) || [];
        let isLightMode = localStorage.getItem('forge_theme') === 'light';
        let isMistakeMode = false; // æ˜¯å¦å¤„äºé”™é¢˜å¤ä¹ æ¨¡å¼

        // === 2. åˆå§‹åŒ– ===
        window.onload = function() {
            if(isLightMode) document.body.classList.add('light-mode');
            initBookSelector();
            updateWrongUI();

            // æ£€æŸ¥å­˜æ¡£
            const savedData = localStorage.getItem('forge_progress_v5');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if(parsed.queue && parsed.queue.length > 0) {
                        wordQueue = parsed.queue;
                        mainQueue = parsed.queue; // å‡è®¾ä¸Šæ¬¡æ²¡èƒŒå®Œçš„æ˜¯å…¨éƒ¨
                        currentIndex = parsed.index;
                        currentBookName = parsed.bookName;
                        
                        document.getElementById('current-book-name').textContent = currentBookName;
                        document.getElementById('book-modal').style.display = 'none';
                        loadCard(currentIndex);
                        showToast("å·²æ¢å¤ä¸Šæ¬¡è¿›åº¦");
                        return;
                    }
                } catch(e) { localStorage.removeItem('forge_progress_v5'); }
            }
            document.getElementById('book-modal').style.display = 'flex';
        };

        function initBookSelector() {
            const list = document.getElementById('book-list');
            list.innerHTML = '';
            books.forEach(book => {
                const btn = document.createElement('button');
                btn.className = 'book-btn';
                btn.textContent = book.name;
                btn.onclick = () => loadBook(book);
                list.appendChild(btn);
            });
        }

        // === 3. æ•°æ®åŠ è½½ ===
        function loadBook(book) {
            showToast("æ­£åœ¨åŠ è½½ " + book.name);
            fetch(book.file).then(res => {
                if(!res.ok) throw new Error("æ–‡ä»¶404");
                return res.json();
            }).then(data => {
                wordQueue = cleanData(data);
                wordQueue.sort(() => Math.random() - 0.5); // ä¹±åº
                mainQueue = [...wordQueue]; // å¤‡ä»½å®Œæ•´åˆ—è¡¨ç”¨äºå‡ºé¢˜å¹²æ‰°é¡¹
                
                currentIndex = 0;
                currentBookName = book.name;
                isMistakeMode = false;
                
                saveProgress();
                document.getElementById('current-book-name').textContent = book.name;
                document.getElementById('book-modal').style.display = 'none';
                loadCard(0);
            }).catch(e => alert("åŠ è½½å¤±è´¥: " + e.message + "\nè¯·ç¡®è®¤ä½¿ç”¨äº†Live Serverä¸”è·¯å¾„æ­£ç¡®(éœ€åŒ…å«jsonæ–‡ä»¶å¤¹)"));
        }

        function cleanData(data) {
            return data.map(item => ({
                word: item.word,
                phonetic: item.phonetic || "",
                meaning: (item.translations || []).map(t => t.translation).join('; '),
                sentence: (item.phrases && item.phrases[0]) ? `${item.phrases[0].phrase}<br>${item.phrases[0].translation}` : "No sentence available."
            }));
        }

        function saveProgress() {
            if(isMistakeMode) return; // é”™é¢˜æ¨¡å¼ä¸ä¿å­˜ä¸ºä¸»è¿›åº¦
            localStorage.setItem('forge_progress_v5', JSON.stringify({
                bookName: currentBookName,
                queue: wordQueue,
                index: currentIndex
            }));
        }

        function resetProgress() {
            if(confirm("ç¡®å®šæ¢ä¹¦å—ï¼Ÿå½“å‰è¿›åº¦å°†é‡ç½®ã€‚")) {
                localStorage.removeItem('forge_progress_v5');
                location.reload();
            }
        }

        // === 4. èƒŒè¯é€»è¾‘ ===
        function loadCard(index) {
            if (!wordQueue[index]) return;
            const data = wordQueue[index];
            const card = document.querySelector('.card-container');
            card.classList.remove('flipped');
            
            let progressText = isMistakeMode ? `é”™é¢˜å¤ä¹ : ${index + 1} / ${wordQueue.length}` : `${index + 1} / ${wordQueue.length}`;
            document.getElementById('progress-display').textContent = progressText;
            
            setTimeout(() => {
                document.getElementById('card-word').textContent = data.word;
                document.getElementById('card-phonetic').textContent = data.phonetic;
                document.getElementById('card-meaning').innerHTML = data.meaning;
                document.getElementById('card-sentence').innerHTML = data.sentence;
            }, 200);
        }

        function flipCard() {
            document.querySelector('.card-container').classList.toggle('flipped');
        }

        function rateWord(score) {
            const currentWord = wordQueue[currentIndex];
            
            if (score === 0) {
                // è®°ä¸ä½ï¼šåŠ å…¥é”™é¢˜æœ¬
                if (!wrongWords.find(w => w.word === currentWord.word)) {
                    wrongWords.push(currentWord);
                    localStorage.setItem('forge_wrong_words', JSON.stringify(wrongWords));
                    updateWrongUI();
                }
            } else if (score === 1 && isMistakeMode) {
                // é”™é¢˜æ¨¡å¼ä¸‹è®°ä½äº†ï¼šç§»å‡ºé”™é¢˜æœ¬
                wrongWords = wrongWords.filter(w => w.word !== currentWord.word);
                localStorage.setItem('forge_wrong_words', JSON.stringify(wrongWords));
                updateWrongUI();
                showToast("å·²æ¶ˆç­è¯¥é”™é¢˜ï¼");
            }

            currentIndex++;
            if(!isMistakeMode) saveProgress();

            if (currentIndex >= wordQueue.length) {
                alert(isMistakeMode ? "é”™é¢˜å¤ä¹ å®Œæ¯•ï¼" : "æœ¬è½®å•è¯ç»“æŸï¼Œå³å°†é‡æ–°ä¹±åºï¼");
                if(!isMistakeMode) wordQueue.sort(() => Math.random() - 0.5);
                currentIndex = 0;
            }
            loadCard(currentIndex);
        }

        // === 5. æ–°å¢ï¼šæ·±åº¦æœç´¢åŠŸèƒ½ ===
        function openSearch(e, type) {
            e.stopPropagation();
            const word = wordQueue[currentIndex].word;
            let url = "";
            if(type === 'etym') url = `https://www.etymonline.com/word/${word}`;
            if(type === 'cambridge') url = `https://dictionary.cambridge.org/zhs/%E8%AF%8D%E5%85%B8/%E8%8B%B1%E8%AF%AD-%E6%B1%89%E8%AF%AD-%E7%AE%80%E4%BD%93/${word}`;
            if(type === 'thesaurus') url = `https://www.thesaurus.com/browse/${word}`;
            if(type === 'bing') url = `https://cn.bing.com/images/search?q=${word}`;
            window.open(url, '_blank');
        }

        // === 6. æ–°å¢ï¼šé”™é¢˜æœ¬å¤ä¹ æ¨¡å¼ ===
        function startMistakeReview() {
            if(wrongWords.length === 0) return alert("é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼Œå…ˆå»èƒŒè¯å§ï¼");
            wordQueue = [...wrongWords]; // å¤åˆ¶é”™é¢˜åˆ°èƒŒè¯µé˜Ÿåˆ—
            wordQueue.sort(() => Math.random() - 0.5);
            currentIndex = 0;
            isMistakeMode = true;
            
            document.getElementById('learn-mode-tag').style.display = 'inline-block';
            switchTab('learn');
            loadCard(0);
            showToast("è¿›å…¥é”™é¢˜å¤ä¹ æ¨¡å¼");
        }

        function updateWrongUI() {
            document.getElementById('wrong-count').textContent = wrongWords.length;
            const container = document.getElementById('wrong-container');
            container.innerHTML = '';
            wrongWords.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<div><b>${item.word}</b><br><small>${item.meaning.substring(0,15)}...</small></div><button onclick="removeWrong(${idx})" style="background:var(--danger);color:white;border:none;padding:5px 10px;border-radius:4px">Ã—</button>`;
                container.appendChild(div);
            });
        }

        function removeWrong(idx) {
            wrongWords.splice(idx, 1);
            localStorage.setItem('forge_wrong_words', JSON.stringify(wrongWords));
            updateWrongUI();
        }
        
        function clearWrongBook() {
            if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) {
                wrongWords = [];
                localStorage.setItem('forge_wrong_words', "[]");
                updateWrongUI();
            }
        }

        function exportPDF() {
            if(wrongWords.length===0) return alert("æ²¡æœ‰é”™é¢˜");
            const w = window.open();
            let html = "<h2>æˆ‘çš„ç”Ÿè¯æœ¬</h2><table border='1' style='width:100%;border-collapse:collapse'><tr><th>å•è¯</th><th>é‡Šä¹‰</th><th>ä¾‹å¥</th></tr>";
            wrongWords.forEach(i => html+=`<tr><td>${i.word}</td><td>${i.meaning}</td><td>${i.sentence}</td></tr>`);
            html+="</table>";
            w.document.write(html);
            w.print();
        }

        // === 7. æ–°å¢ï¼šé€‰è¯æµ‹è¯• (Quiz) ===
        function generateQuiz() {
            if(mainQueue.length < 4) return;
            // éšæœºé€‰ä¸€ä¸ªæ­£ç¡®çš„
            const correct = mainQueue[Math.floor(Math.random() * mainQueue.length)];
            // éšæœºé€‰3ä¸ªé”™è¯¯çš„
            let options = [correct];
            while(options.length < 4) {
                let r = mainQueue[Math.floor(Math.random() * mainQueue.length)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-word').textContent = correct.word;
            const container = document.getElementById('quiz-options');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-btn';
                btn.innerText = opt.meaning.split(';')[0]; // åªå–ç¬¬ä¸€ä¸ªæ„æ€
                btn.onclick = function() {
                    if(opt === correct) {
                        this.classList.add('correct');
                        setTimeout(generateQuiz, 600);
                    } else {
                        this.classList.add('wrong');
                    }
                };
                container.appendChild(btn);
            });
        }

        // === 8. æ–°å¢ï¼šå®Œå½¢å¡«ç©º (Cloze) ===
        function generateCloze() {
            if(mainQueue.length < 4) return;
            // æ‰¾ä¸€ä¸ªæœ‰ä¾‹å¥çš„è¯
            let correct;
            let attempts = 0;
            do {
                correct = mainQueue[Math.floor(Math.random() * mainQueue.length)];
                attempts++;
            } while (correct.sentence.includes("No sentence") && attempts < 20);

            // å¤„ç†ä¾‹å¥ï¼šå»æ‰HTMLæ ‡ç­¾ï¼Œæ‰¾åˆ°å•è¯ä½ç½®æ›¿æ¢
            let rawSent = correct.sentence.replace(/<[^>]*>/g, ""); // å»é™¤ bold ç­‰æ ‡ç­¾
            // ç®€å•çš„æ­£åˆ™æ›¿æ¢ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            const regex = new RegExp(correct.word, "gi");
            if(!regex.test(rawSent)) {
                // å¦‚æœä¾‹å¥é‡Œæ²¡ç›´æ¥å‡ºç°å•è¯(å¯èƒ½æ˜¯å˜å½¢)ï¼Œå°±é‡éšä¸€ä¸ª
                return generateCloze();
            }
            
            const clozeSent = rawSent.replace(regex, `<span class="cloze-blank">____</span>`);
            
            document.getElementById('cloze-sentence').innerHTML = clozeSent;
            
            // é€‰é¡¹
            let options = [correct];
            while(options.length < 4) {
                let r = mainQueue[Math.floor(Math.random() * mainQueue.length)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);
            
            const container = document.getElementById('cloze-options');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-btn';
                btn.innerText = opt.word;
                btn.onclick = function() {
                    if(opt === correct) {
                        this.classList.add('correct');
                        document.querySelector('.cloze-blank').textContent = correct.word;
                        setTimeout(generateCloze, 1000);
                    } else {
                        this.classList.add('wrong');
                    }
                };
                container.appendChild(btn);
            });
        }

        // === è¾…åŠ©åŠŸèƒ½ ===
        function playAudio() {
            const txt = wordQueue[currentIndex]?.word;
            if(txt) window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
        }

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            
            if(id === 'quiz') generateQuiz();
            if(id === 'cloze') generateCloze();
            
            if(id === 'learn' && isMistakeMode) {
                document.getElementById('learn-mode-tag').style.display = 'inline-block';
            } else {
                document.getElementById('learn-mode-tag').style.display = 'none';
            }
        }

        function toggleTheme() {
            isLightMode = !isLightMode;
            document.body.classList.toggle('light-mode', isLightMode);
            localStorage.setItem('forge_theme', isLightMode ? 'light' : 'dark');
        }

        function toggleStats() {
            document.getElementById('stats-panel').classList.toggle('open');
        }

        function showToast(text) {
            const t = document.getElementById('toast');
            t.textContent = text; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>