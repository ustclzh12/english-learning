<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE FORGE - V6.0 æ——èˆ°ä¿®æ­£ç‰ˆ</title>
    <style>
        /* === 1. æ ¸å¿ƒè§†è§‰ç³»ç»Ÿ === */
        :root {
            --bg: #121212; --sidebar: #181818; --card: #1e1e1e;
            --text: #e0e0e0; --sub-text: #a0a0a0;
            --accent: #bb86fc; --success: #03dac6; --danger: #cf6679; --info: #2196f3;
            --border: #333; --shadow: rgba(0,0,0,0.5);
        }
        body.light-mode {
            --bg: #f0f2f5; --sidebar: #ffffff; --card: #ffffff;
            --text: #333333; --sub-text: #666666;
            --accent: #6200ee; --success: #018786; --danger: #b00020; --info: #0288d1;
            --border: #ddd; --shadow: rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 240px 1fr 280px; overflow: hidden; transition: 0.3s; }

        /* === æ‰‹æœºç«¯é€‚é… === */
        @media (max-width: 768px) {
            body { grid-template-columns: 1fr; grid-template-rows: 60px 1fr 0px; }
            .sidebar {
                flex-direction: row !important; position: fixed; bottom: 0; width: 100%; height: 60px;
                border-top: 1px solid var(--border); border-right: none !important; padding: 0 !important;
                justify-content: space-around; z-index: 100; overflow-x: auto;
            }
            .sidebar .logo { display: none; }
            .nav-item { flex-direction: column; font-size: 10px; padding: 5px 10px !important; gap: 2px !important; min-width: 60px; justify-content: center; }
            .nav-text { display: block !important; }
            
            .stats-panel { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; z-index: 150; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
            .stats-panel.open { right: 0; }
            .mobile-header { display: flex !important; }
            .card-container { height: 400px !important; margin-top: 10px; }
            .word-text { font-size: 38px !important; }
        }

        .mobile-header { display: none; justify-content: space-between; align-items: center; padding: 0 20px; background: var(--sidebar); border-bottom: 1px solid var(--border); z-index: 50; }

        /* === ä¾§è¾¹æ  === */
        .sidebar { background-color: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .logo { font-size: 20px; font-weight: bold; color: var(--accent); letter-spacing: 1px; margin-bottom: 15px; cursor: pointer;}
        .nav-item { padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: var(--sub-text); display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: var(--bg); color: var(--text); }

        /* === ä¸»åŒºåŸŸ === */
        .main-area { position: relative; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; } /* åº•éƒ¨ç•™ç™½ç»™æ‰¹é‡æ“ä½œæ  */
        .page-section { display: none; padding: 20px; min-height: 100%; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .page-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* èƒŒè¯å¡ç‰‡ */
        .card-container { width: 100%; max-width: 500px; height: 450px; perspective: 1000px; cursor: pointer; margin-bottom: 20px; position: relative;}
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.5s; transform-style: preserve-3d; box-shadow: 0 10px 30px var(--shadow); border-radius: 20px; }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background-color: var(--card); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; border: 1px solid var(--border); }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; padding-top: 30px; }
        
        .word-text { font-size: 46px; font-weight: bold; margin-bottom: 10px; color: var(--text); }
        .phonetic { font-family: 'Times New Roman', serif; font-size: 18px; color: var(--accent); margin-bottom: 15px; }
        .meaning { font-size: 18px; margin-bottom: 15px; color: var(--success); line-height: 1.5; width: 100%; max-height: 100px; overflow-y: auto;}
        .sentence { font-style: italic; color: var(--sub-text); margin: 10px 0; padding: 12px; background: var(--bg); border-radius: 10px; width: 100%; text-align: left; border-left: 3px solid var(--accent); font-size: 14px; max-height: 80px; overflow-y: auto;}

        /* æ·±åº¦æœç´¢æŒ‰é’® */
        .search-links { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: auto; width: 100%; }
        .link-btn { font-size: 12px; padding: 6px 10px; border-radius: 15px; background: var(--bg); border: 1px solid var(--border); color: var(--sub-text); text-decoration: none; transition: 0.2s; }
        .link-btn:hover { border-color: var(--accent); color: var(--accent); }

        .controls { display: flex; gap: 15px; width: 100%; max-width: 500px; margin-bottom: 20px; }
        .btn-control { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; color: #fff; transition: 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-control:active { transform: scale(0.95); }

        /* é”™é¢˜æœ¬åˆ—è¡¨ */
        .list-container { width: 100%; max-width: 600px; display: grid; gap: 10px; margin-bottom: 60px; }
        .list-item { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .list-item.selected { border-color: var(--accent); background: rgba(187, 134, 252, 0.1); }
        .checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent); }
        
        /* æ‰¹é‡æ“ä½œæ  */
        .bulk-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 10px 20px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; gap: 10px; z-index: 100; border: 1px solid var(--accent); display: none; }
        .bulk-actions.show { display: flex; }
        .bulk-btn { background: none; border: none; color: var(--text); cursor: pointer; font-size: 14px; padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; }
        .bulk-btn:hover { background: var(--bg); color: var(--accent); }

        /* Quiz æ ·å¼ä¼˜åŒ– */
        .quiz-container { width: 100%; max-width: 500px; text-align: center; }
        .quiz-question { font-size: 32px; font-weight: bold; color: var(--text); margin-bottom: 30px; }
        .quiz-options { display: grid; gap: 15px; }
        .quiz-btn { padding: 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 10px; cursor: pointer; font-size: 16px; text-align: left; transition: 0.2s; position: relative; }
        .quiz-btn:hover { border-color: var(--accent); }
        .quiz-btn.correct { background: var(--success); color: black; border-color: var(--success); }
        .quiz-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        /* æ­ç¤ºç­”æ¡ˆçš„å°å­— */
        .reveal-text { display: block; font-size: 12px; margin-top: 5px; opacity: 0.8; font-weight: bold; }
        
        .quiz-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .quiz-footer.show { opacity: 1; pointer-events: all; }

        /* å³ä¾§é¢æ¿ */
        .stats-panel { background-color: var(--sidebar); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;}
        .stat-card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-val { font-size: 24px; font-weight: bold; margin-top: 5px; color: var(--text); }
        
        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 90%; max-width: 400px; border-radius: 15px; padding: 25px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; text-align: center;}
        .book-btn { display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px; text-align: left; cursor: pointer; font-size: 16px; font-weight: 600; }

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300; }
        .toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div class="logo">âš¡ THE FORGE</div>
        <div style="font-size: 24px; cursor: pointer;" onclick="toggleStats()">ğŸ“Š</div>
    </div>

    <!-- é€‰ä¹¦å¼¹çª— -->
    <div class="modal-overlay" id="book-modal">
        <div class="modal-content">
            <h2 style="color:var(--text); margin-bottom: 20px;">ğŸ“š é€‰æ‹©ä¸€æœ¬è¯ä¹¦</h2>
            <div id="book-list"><p style="color:red">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</p></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo desktop-only">âš¡ THE FORGE</div>
        <div class="nav-item active" onclick="switchTab('learn')"><span class="nav-icon">ğŸ </span><span class="nav-text">èƒŒå•è¯</span></div>
        <div class="nav-item" onclick="switchTab('wrong')"><span class="nav-icon">ğŸ““</span><span class="nav-text">é”™é¢˜æœ¬</span></div>
        <div class="nav-item" onclick="switchTab('quiz')"><span class="nav-icon">ğŸ¯</span><span class="nav-text">é€‰è¯</span></div>
        <div class="nav-item" onclick="switchTab('cloze')"><span class="nav-icon">ğŸ§©</span><span class="nav-text">å¡«ç©º</span></div>
        <div class="nav-item" onclick="toggleTheme()"><span class="nav-icon">â˜€ï¸</span><span class="nav-text">ä¸»é¢˜</span></div>
        <div class="nav-item" onclick="resetProgress()"><span class="nav-icon">ğŸ”„</span><span class="nav-text">æ¢ä¹¦</span></div>
    </div>

    <div class="main-area">
        
        <!-- 1. èƒŒè¯æ¨¡å¼ -->
        <div id="section-learn" class="page-section active">
            <!-- ä¿®å¤ï¼šé¡¶éƒ¨çŠ¶æ€æ  + é€€å‡ºæŒ‰é’® -->
            <div style="width:100%; max-width:500px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <div style="color: var(--sub-text); font-size: 14px;">
                    <span id="learn-mode-tag" style="background:var(--accent); color:black; padding:2px 6px; border-radius:4px; font-size:10px; display:none; margin-right:5px">é”™é¢˜å¤ä¹ ä¸­</span>
                    ä¹¦å: <span id="current-book-name" style="color:var(--accent); font-weight:bold">...</span>
                </div>
                <button id="exit-mistake-btn" onclick="exitMistakeMode()" style="display:none; background:var(--bg); border:1px solid var(--sub-text); color:var(--text); padding:5px 10px; border-radius:15px; font-size:12px; cursor:pointer;">â†© é€€å‡ºå¤ä¹ </button>
            </div>
            
            <div class="card-container" onclick="flipCard()">
                <div class="card-inner">
                    <div class="card-face card-front">
                        <div class="word-text" id="card-word">Loading...</div>
                        <div class="phonetic" id="card-phonetic"> </div>
                        <button onclick="event.stopPropagation(); playAudio()" style="background:none; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:20px; cursor:pointer;">ğŸ”Š å‘éŸ³</button>
                        <div style="margin-top:auto; font-size: 12px; color: var(--sub-text);">(ç‚¹å‡»æŸ¥çœ‹èƒŒé¢)</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="meaning" id="card-meaning">...</div>
                        <div class="sentence" id="card-sentence">...</div>
                        <div style="margin-top:auto; width:100%">
                            <div class="search-links">
                                <a href="#" onclick="openSearch(event, 'etym')" class="link-btn">ğŸŒ± è¯æ ¹</a>
                                <a href="#" onclick="openSearch(event, 'cambridge')" class="link-btn">ğŸ‡¬ğŸ‡§ æ­é…</a>
                                <a href="#" onclick="openSearch(event, 'thesaurus')" class="link-btn">ğŸ”— è¿‘ä¹‰</a>
                                <a href="#" onclick="openSearch(event, 'bing')" class="link-btn">ğŸ–¼ï¸ å›¾ç‰‡</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn-control" style="background:var(--danger)" onclick="rateWord(0)">ğŸ˜© è®°ä¸ä½</button>
                <button class="btn-control" style="background:var(--success)" onclick="rateWord(1)">ğŸ˜ è®°ä½äº†</button>
            </div>
        </div>

        <!-- 2. é”™é¢˜æœ¬ (å«æ‰¹é‡æ“ä½œ) -->
        <div id="section-wrong" class="page-section">
            <h2 style="color:var(--text); margin-bottom: 20px;">ğŸ““ é”™é¢˜æœ¬</h2>
            <div style="width:100%; max-width:600px; display:flex; justify-content:space-between; margin-bottom:10px; color:var(--sub-text); font-size:12px">
                <label style="display:flex; align-items:center; gap:5px; cursor:pointer">
                    <input type="checkbox" onchange="toggleSelectAll(this)"> å…¨é€‰
                </label>
                <span id="selected-count">å·²é€‰: 0</span>
            </div>
            <div class="list-container" id="wrong-container"></div>
            
            <!-- æ‚¬æµ®æ‰¹é‡æ“ä½œæ  -->
            <div class="bulk-actions" id="bulk-bar">
                <button class="bulk-btn" onclick="bulkReview()">ğŸš€ å¤ä¹ é€‰ä¸­</button>
                <button class="bulk-btn" onclick="bulkAI()">ğŸ¤– AIé˜…è¯»</button>
                <button class="bulk-btn" style="color:var(--danger)" onclick="bulkDelete()">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
        </div>

        <!-- 3. é€‰è¯æµ‹è¯• (ä¿®æ­£ç‰ˆ) -->
        <div id="section-quiz" class="page-section">
            <h2 style="margin-bottom:20px; color:var(--sub-text)">ğŸ¯ é€‰è¯æµ‹è¯• (4é€‰1)</h2>
            <div class="quiz-container">
                <div class="quiz-question" id="quiz-word">Word</div>
                <div class="quiz-options" id="quiz-options"></div>
                
                <!-- åº•éƒ¨æ“ä½œæ  -->
                <div class="quiz-footer" id="quiz-footer">
                    <button class="btn-control" style="background:var(--danger); font-size:14px; padding:10px" onclick="addQuizToMistake()">ğŸ““ åŠ å…¥é”™é¢˜</button>
                    <button class="btn-control" style="background:var(--accent); font-size:14px; padding:10px" onclick="generateQuiz()">â¡ï¸ ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </div>

        <!-- 4. å®Œå½¢å¡«ç©º -->
        <div id="section-cloze" class="page-section">
            <h2 style="margin-bottom:20px; color:var(--sub-text)">ğŸ§© çœŸé¢˜è¯­å¢ƒå¡«ç©º</h2>
            <div class="quiz-container">
                <div class="quiz-question" id="cloze-sentence" style="font-size:20px; text-align:left; background:var(--card); padding:20px; border-radius:10px; border:1px solid var(--border)">Loading...</div>
                <div class="quiz-options" id="cloze-options" style="margin-top:20px"></div>
            </div>
        </div>

    </div>

    <!-- å³ä¾§é¢æ¿ -->
    <div class="stats-panel" id="stats-panel">
        <div style="display: flex; justify-content: space-between;">
            <h3 style="color:var(--text)">å­¦ä¹ è¿›åº¦</h3>
            <span style="font-size: 24px; cursor: pointer;" onclick="toggleStats()">âœ•</span>
        </div>
        <div class="stat-card">
            <div style="font-size: 12px; color: var(--sub-text);">å½“å‰è¿›åº¦</div>
            <div class="stat-val" id="progress-display">0 / 0</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 12px; color: var(--sub-text);">é”™é¢˜ç§¯ç´¯</div>
            <div class="stat-val" style="color: var(--danger)" id="wrong-count">0</div>
        </div>
    </div>

    <div class="toast" id="toast">æç¤º</div>

    <script>
        // === é…ç½®è·¯å¾„ ===
        const books = [
            { name: "åˆä¸­è¯æ±‡", file: "json/1-åˆä¸­-é¡ºåº.json" },
            { name: "é«˜ä¸­è¯æ±‡", file: "json/2-é«˜ä¸­-é¡ºåº.json" },
            { name: "å››çº§è¯æ±‡", file: "json/3-CET4-é¡ºåº.json" },
            { name: "å…­çº§è¯æ±‡", file: "json/4-CET6-é¡ºåº.json" },
            { name: "è€ƒç ”è¯æ±‡", file: "json/5-è€ƒç ”-é¡ºåº.json" },
            { name: "æ‰˜ç¦è¯æ±‡", file: "json/6-æ‰˜ç¦-é¡ºåº.json" },
            { name: "SATè¯æ±‡", file: "json/7-SAT-é¡ºåº.json" }
        ];

        // å…¨å±€å˜é‡
        let fullBookQueue = []; // å®Œæ•´ä¹¦æœ¬æ•°æ® (ç”¨äºæ¢å¤)
        let currentQueue = [];  // å½“å‰èƒŒè¯µé˜Ÿåˆ—
        let currentIndex = 0;
        let currentBookName = "";
        let wrongWords = JSON.parse(localStorage.getItem('forge_wrong_words')) || [];
        let isLightMode = localStorage.getItem('forge_theme') === 'light';
        let isMistakeMode = false;
        let selectedMistakeIndices = new Set(); // å­˜å‚¨é€‰ä¸­çš„é”™é¢˜ç´¢å¼•
        let currentQuizCorrectWord = null; // å½“å‰Quizçš„æ­£ç¡®å•è¯å¯¹è±¡

        // === åˆå§‹åŒ– ===
        window.onload = function() {
            if(isLightMode) document.body.classList.add('light-mode');
            initBookSelector();
            updateWrongUI();

            const savedData = localStorage.getItem('forge_progress_v6');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if(parsed.queue && parsed.queue.length > 0) {
                        currentQueue = parsed.queue;
                        fullBookQueue = parsed.fullQueue || parsed.queue; // å…¼å®¹æ—§ç‰ˆ
                        currentIndex = parsed.index;
                        currentBookName = parsed.bookName;
                        
                        document.getElementById('current-book-name').textContent = currentBookName;
                        document.getElementById('book-modal').style.display = 'none';
                        loadCard(currentIndex);
                        showToast("å·²æ¢å¤è¿›åº¦");
                        return;
                    }
                } catch(e) { localStorage.removeItem('forge_progress_v6'); }
            }
            document.getElementById('book-modal').style.display = 'flex';
        };

        function initBookSelector() {
            const list = document.getElementById('book-list');
            list.innerHTML = '';
            books.forEach(book => {
                const btn = document.createElement('button');
                btn.className = 'book-btn';
                btn.textContent = book.name;
                btn.onclick = () => loadBook(book);
                list.appendChild(btn);
            });
        }

        // === æ ¸å¿ƒæ•°æ®é€»è¾‘ ===
        function loadBook(book) {
            showToast("åŠ è½½ä¸­...");
            fetch(book.file).then(res => res.json()).then(data => {
                fullBookQueue = cleanData(data);
                fullBookQueue.sort(() => Math.random() - 0.5); // ä¹±åº
                currentQueue = [...fullBookQueue]; // å¤åˆ¶ä¸€ä»½ä½œä¸ºå½“å‰èƒŒè¯µé˜Ÿåˆ—
                
                currentIndex = 0;
                currentBookName = book.name;
                isMistakeMode = false;
                
                saveProgress();
                updateLearnUI();
                document.getElementById('book-modal').style.display = 'none';
                loadCard(0);
            }).catch(e => alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„"));
        }

        function cleanData(data) {
            return data.map(item => ({
                word: item.word,
                phonetic: item.phonetic || "",
                meaning: (item.translations || []).map(t => t.translation).join('; '),
                sentence: (item.phrases && item.phrases[0]) ? `${item.phrases[0].phrase}<br>${item.phrases[0].translation}` : "No sentence."
            }));
        }

        function saveProgress() {
            if(isMistakeMode) return;
            localStorage.setItem('forge_progress_v6', JSON.stringify({
                bookName: currentBookName,
                queue: currentQueue,
                fullQueue: fullBookQueue,
                index: currentIndex
            }));
        }

        function resetProgress() {
            if(confirm("ç¡®å®šæ¢ä¹¦ï¼Ÿ")) {
                localStorage.removeItem('forge_progress_v6');
                location.reload();
            }
        }

        // === èƒŒè¯é€»è¾‘ ===
        function loadCard(index) {
            if (!currentQueue[index]) return;
            const data = currentQueue[index];
            const card = document.querySelector('.card-container');
            card.classList.remove('flipped');
            
            let progressText = isMistakeMode ? `é”™é¢˜å¤ä¹ : ${index + 1} / ${currentQueue.length}` : `${index + 1} / ${currentQueue.length}`;
            document.getElementById('progress-display').textContent = progressText;
            
            setTimeout(() => {
                document.getElementById('card-word').textContent = data.word;
                document.getElementById('card-phonetic').textContent = data.phonetic;
                document.getElementById('card-meaning').innerHTML = data.meaning;
                document.getElementById('card-sentence').innerHTML = data.sentence;
            }, 200);
        }

        function flipCard() {
            document.querySelector('.card-container').classList.toggle('flipped');
        }

        function rateWord(score) {
            const currentWord = currentQueue[currentIndex];
            if (score === 0) {
                if (!wrongWords.find(w => w.word === currentWord.word)) {
                    wrongWords.push(currentWord);
                    localStorage.setItem('forge_wrong_words', JSON.stringify(wrongWords));
                    updateWrongUI();
                }
            } else if (score === 1 && isMistakeMode) {
                // å¤ä¹ æ¨¡å¼ä¸‹è®°ä½äº†ï¼Œå¯ä»¥é€‰æ‹©ç§»é™¤ï¼ˆè¿™é‡Œæš‚ä¸è‡ªåŠ¨ç§»é™¤ï¼Œé˜²æ­¢è¯¯ç‚¹ï¼‰
            }

            currentIndex++;
            if(!isMistakeMode) saveProgress();

            if (currentIndex >= currentQueue.length) {
                alert(isMistakeMode ? "å¤ä¹ å®Œæ¯•ï¼Œå³å°†è¿”å›ä¸»ç•Œé¢" : "æœ¬è½®ç»“æŸï¼Œå³å°†ä¹±åºï¼");
                if(isMistakeMode) {
                    exitMistakeMode();
                } else {
                    currentQueue.sort(() => Math.random() - 0.5);
                    currentIndex = 0;
                    loadCard(0);
                }
            } else {
                loadCard(currentIndex);
            }
        }

        // === å¤ä¹ æ¨¡å¼åˆ‡æ¢ (Bugä¿®å¤æ ¸å¿ƒ) ===
        function exitMistakeMode() {
            currentQueue = [...fullBookQueue]; // æ¢å¤ä¸»é˜Ÿåˆ—
            // å°è¯•æ¢å¤ä¸Šæ¬¡è¿›åº¦ç´¢å¼•ï¼Œå¦‚æœè¶Šç•Œå½’é›¶
            const savedData = JSON.parse(localStorage.getItem('forge_progress_v6'));
            currentIndex = savedData ? savedData.index : 0;
            
            isMistakeMode = false;
            updateLearnUI();
            loadCard(currentIndex);
            showToast("å·²å›åˆ°æ­£å¸¸æ¨¡å¼");
        }

        function updateLearnUI() {
            document.getElementById('current-book-name').textContent = currentBookName;
            const tag = document.getElementById('learn-mode-tag');
            const btn = document.getElementById('exit-mistake-btn');
            
            if(isMistakeMode) {
                tag.style.display = 'inline-block';
                btn.style.display = 'block';
            } else {
                tag.style.display = 'none';
                btn.style.display = 'none';
            }
        }

        // === é”™é¢˜æœ¬ä¸æ‰¹é‡æ“ä½œ ===
        function updateWrongUI() {
            document.getElementById('wrong-count').textContent = wrongWords.length;
            const container = document.getElementById('wrong-container');
            container.innerHTML = '';
            
            wrongWords.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                if(selectedMistakeIndices.has(idx)) div.classList.add('selected');
                
                div.innerHTML = `
                    <input type="checkbox" class="checkbox" ${selectedMistakeIndices.has(idx) ? 'checked' : ''} onchange="toggleSelect(${idx})">
                    <div style="flex:1" onclick="toggleSelect(${idx})">
                        <div style="font-weight:bold">${item.word}</div>
                        <div style="font-size:12px;color:var(--sub-text)">${item.meaning.split(';')[0]}</div>
                    </div>
                `;
                container.appendChild(div);
            });
            updateBulkBar();
        }

        function toggleSelect(idx) {
            if(selectedMistakeIndices.has(idx)) selectedMistakeIndices.delete(idx);
            else selectedMistakeIndices.add(idx);
            updateWrongUI();
        }

        function toggleSelectAll(checkbox) {
            if(checkbox.checked) {
                wrongWords.forEach((_, i) => selectedMistakeIndices.add(i));
            } else {
                selectedMistakeIndices.clear();
            }
            updateWrongUI();
        }

        function updateBulkBar() {
            const bar = document.getElementById('bulk-bar');
            const countSpan = document.getElementById('selected-count');
            if(countSpan) countSpan.textContent = `å·²é€‰: ${selectedMistakeIndices.size}`;
            
            if(selectedMistakeIndices.size > 0) bar.classList.add('show');
            else bar.classList.remove('show');
        }

        function bulkDelete() {
            if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedMistakeIndices.size} ä¸ªè¯ï¼Ÿ`)) return;
            wrongWords = wrongWords.filter((_, i) => !selectedMistakeIndices.has(i));
            selectedMistakeIndices.clear();
            localStorage.setItem('forge_wrong_words', JSON.stringify(wrongWords));
            updateWrongUI();
        }

        function bulkReview() {
            const selected = wrongWords.filter((_, i) => selectedMistakeIndices.has(i));
            if(selected.length === 0) return;
            
            currentQueue = [...selected];
            currentQueue.sort(() => Math.random() - 0.5);
            currentIndex = 0;
            isMistakeMode = true;
            
            updateLearnUI();
            switchTab('learn');
            loadCard(0);
            showToast(`å¼€å§‹å¤ä¹ é€‰ä¸­çš„ ${selected.length} ä¸ªè¯`);
        }

        function bulkAI() {
            const selectedWords = wrongWords.filter((_, i) => selectedMistakeIndices.has(i)).map(w => w.word);
            const prompt = `è¯·ç”¨ä»¥ä¸‹è‹±è¯­å•è¯ç¼–å†™ä¸€ç¯‡å®Œå½¢å¡«ç©ºç»ƒä¹ é¢˜ï¼Œè¦æ±‚åŒ…å«ç­”æ¡ˆå’Œè§£æï¼š\n${selectedWords.join(', ')}`;
            
            navigator.clipboard.writeText(prompt).then(() => {
                alert("å·²å¤åˆ¶ Prompt åˆ°å‰ªè´´æ¿ï¼\n\nè¯·å» ChatGPT/Kimi ç²˜è´´ï¼Œå³å¯ç”Ÿæˆä¸“å±é˜…è¯»é¢˜ã€‚");
            });
        }

        // === é€‰è¯æµ‹è¯• (Quiz) ä¿®æ­£ç‰ˆ ===
        function generateQuiz() {
            if(fullBookQueue.length < 4) return;
            document.getElementById('quiz-footer').classList.remove('show');
            
            const correct = fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)];
            currentQuizCorrectWord = correct;
            
            let options = [correct];
            while(options.length < 4) {
                let r = fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-word').textContent = correct.word;
            const container = document.getElementById('quiz-options');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-btn';
                btn.innerHTML = `
                    <span>${opt.meaning.split(';')[0]}</span>
                    <span class="reveal-text" style="display:none">(${opt.word})</span>
                `;
                btn.onclick = function() {
                    // æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ
                    document.querySelectorAll('.reveal-text').forEach(el => el.style.display = 'block');
                    document.getElementById('quiz-footer').classList.add('show');
                    
                    if(opt === correct) {
                        this.classList.add('correct');
                    } else {
                        this.classList.add('wrong');
                        // é«˜äº®æ­£ç¡®ç­”æ¡ˆ
                        Array.from(container.children).forEach(child => {
                            if(child.innerHTML.includes(correct.word)) child.classList.add('correct');
                        });
                    }
                };
                container.appendChild(btn);
            });
        }

        function addQuizToMistake() {
            if (!wrongWords.find(w => w.word === currentQuizCorrectWord.word)) {
                wrongWords.push(currentQuizCorrectWord);
                localStorage.setItem('forge_wrong_words', JSON.stringify(wrongWords));
                updateWrongUI();
                showToast("å·²åŠ å…¥é”™é¢˜æœ¬");
            } else {
                showToast("å·²åœ¨é”™é¢˜æœ¬ä¸­");
            }
        }

        // === å®Œå½¢å¡«ç©º ===
        function generateCloze() {
            if(fullBookQueue.length < 4) return;
            let correct, rawSent;
            let attempts = 0;
            // å°è¯•æ‰¾ä¸€ä¸ªæœ‰æœ‰æ•ˆä¾‹å¥çš„è¯
            do {
                correct = fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)];
                rawSent = correct.sentence;
                attempts++;
            } while ((rawSent.includes("No sentence") || rawSent.length < 10) && attempts < 50);

            if(attempts >= 50) return document.getElementById('cloze-sentence').textContent = "ä¾‹å¥èµ„æºä¸è¶³ï¼Œè¯·æ¢ä¹¦å°è¯•";

            // æŒ–ç©º
            const regex = new RegExp(correct.word, "gi");
            const clozeSent = rawSent.replace(regex, `<span style="border-bottom:2px solid var(--accent);color:transparent;user-select:none">____</span>`);
            document.getElementById('cloze-sentence').innerHTML = clozeSent;

            // é€‰é¡¹
            let options = [correct];
            while(options.length < 4) {
                let r = fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('cloze-options');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-btn';
                btn.textContent = opt.word;
                btn.onclick = function() {
                    if(opt === correct) {
                        this.classList.add('correct');
                        document.getElementById('cloze-sentence').innerHTML = rawSent.replace(regex, `<span style="color:var(--success);font-weight:bold">${correct.word}</span>`);
                        setTimeout(generateCloze, 1500);
                    } else {
                        this.classList.add('wrong');
                    }
                };
                container.appendChild(btn);
            });
        }

        // === é€šç”¨åŠŸèƒ½ ===
        function openSearch(e, type) {
            e.stopPropagation();
            const word = currentQueue[currentIndex].word;
            let url = "";
            if(type === 'etym') url = `https://www.etymonline.com/word/${word}`;
            if(type === 'cambridge') url = `https://dictionary.cambridge.org/zhs/%E8%AF%8D%E5%85%B8/%E8%8B%B1%E8%AF%AD-%E6%B1%89%E8%AF%AD-%E7%AE%80%E4%BD%93/${word}`;
            if(type === 'thesaurus') url = `https://www.thesaurus.com/browse/${word}`;
            if(type === 'bing') url = `https://cn.bing.com/images/search?q=${word}`;
            window.open(url, '_blank');
        }

        function playAudio() {
            const txt = currentQueue[currentIndex]?.word;
            if(txt) window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
        }

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            if(id === 'quiz') generateQuiz();
            if(id === 'cloze') generateCloze();
        }

        function toggleTheme() {
            isLightMode = !isLightMode;
            document.body.classList.toggle('light-mode', isLightMode);
            localStorage.setItem('forge_theme', isLightMode ? 'light' : 'dark');
        }

        function toggleStats() {
            document.getElementById('stats-panel').classList.toggle('open');
        }

        function showToast(text) {
            const t = document.getElementById('toast');
            t.textContent = text; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>