<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE FORGE - V7.0 äº‘ç«¯æ¦‚å¿µç‰ˆ</title>
    <style>
        /* === 1. æ ¸å¿ƒè§†è§‰ç³»ç»Ÿ === */
        :root {
            --bg: #121212; --sidebar: #181818; --card: #1e1e1e;
            --text: #e0e0e0; --sub-text: #a0a0a0;
            --accent: #bb86fc; --success: #03dac6; --danger: #cf6679; --info: #2196f3;
            --border: #333; --shadow: rgba(0,0,0,0.5);
        }
        body.light-mode {
            --bg: #f0f2f5; --sidebar: #ffffff; --card: #ffffff;
            --text: #333333; --sub-text: #666666;
            --accent: #6200ee; --success: #018786; --danger: #b00020; --info: #0288d1;
            --border: #ddd; --shadow: rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 240px 1fr 280px; overflow: hidden; transition: 0.3s; }

        /* === æ‰‹æœºé€‚é… === */
        @media (max-width: 768px) {
            body { grid-template-columns: 1fr; grid-template-rows: 60px 1fr 0px; }
            .sidebar {
                flex-direction: row !important; position: fixed; bottom: 0; width: 100%; height: 60px;
                border-top: 1px solid var(--border); border-right: none !important; padding: 0 !important;
                justify-content: space-around; z-index: 100; overflow-x: auto;
            }
            .sidebar .logo { display: none; }
            .nav-item { flex-direction: column; font-size: 10px; padding: 5px 8px !important; gap: 2px !important; min-width: 55px; justify-content: center; }
            .nav-text { display: block !important; }
            .stats-panel { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; z-index: 150; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
            .stats-panel.open { right: 0; }
            .mobile-header { display: flex !important; }
            .card-container { height: 400px !important; margin-top: 10px; }
            .word-text { font-size: 38px !important; }
        }

        .mobile-header { display: none; justify-content: space-between; align-items: center; padding: 0 20px; background: var(--sidebar); border-bottom: 1px solid var(--border); z-index: 50; }

        /* === ä¾§è¾¹æ  === */
        .sidebar { background-color: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .logo { font-size: 20px; font-weight: bold; color: var(--accent); letter-spacing: 1px; margin-bottom: 10px; cursor: pointer;}
        .user-card { background: var(--card); padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer;}
        .user-avatar { width: 30px; height: 30px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold; }
        
        .nav-item { padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: var(--sub-text); display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: var(--bg); color: var(--text); }
        .section-title { font-size: 12px; color: var(--sub-text); margin-top: 15px; margin-bottom: 5px; padding-left: 10px; text-transform: uppercase; }

        /* === ä¸»åŒºåŸŸ === */
        .main-area { position: relative; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; }
        .page-section { display: none; padding: 20px; min-height: 100%; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .page-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å¡ç‰‡ */
        .card-container { width: 100%; max-width: 500px; height: 450px; perspective: 1000px; cursor: pointer; margin-bottom: 20px; position: relative;}
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.5s; transform-style: preserve-3d; box-shadow: 0 10px 30px var(--shadow); border-radius: 20px; }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background-color: var(--card); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; border: 1px solid var(--border); }
        .card-back { transform: rotateY(180deg); justify-content: flex-start; padding-top: 30px; }
        
        .word-text { font-size: 46px; font-weight: bold; margin-bottom: 10px; color: var(--text); }
        .phonetic { font-family: 'Times New Roman', serif; font-size: 18px; color: var(--accent); margin-bottom: 15px; }
        .meaning { font-size: 18px; margin-bottom: 15px; color: var(--success); line-height: 1.5; width: 100%; max-height: 100px; overflow-y: auto;}
        .sentence { font-style: italic; color: var(--sub-text); margin: 10px 0; padding: 12px; background: var(--bg); border-radius: 10px; width: 100%; text-align: left; border-left: 3px solid var(--accent); font-size: 14px; max-height: 80px; overflow-y: auto;}

        .controls { display: flex; gap: 15px; width: 100%; max-width: 500px; margin-bottom: 20px; }
        .btn-control { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; color: #fff; transition: 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-control:active { transform: scale(0.95); }

        /* Quiz ä¿®æ­£ç‰ˆæ ·å¼ */
        .quiz-container { width: 100%; max-width: 500px; text-align: center; }
        .quiz-question { font-size: 32px; font-weight: bold; color: var(--text); margin-bottom: 30px; }
        .quiz-option-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: stretch; }
        .quiz-btn { flex: 1; padding: 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 10px; cursor: pointer; font-size: 16px; text-align: left; transition: 0.2s; position: relative; display: flex; justify-content: space-between; align-items: center;}
        .quiz-btn:hover { border-color: var(--accent); }
        .quiz-btn.correct { background: var(--success); color: black; border-color: var(--success); }
        .quiz-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* Quiz å³ä¾§å°åŠ å· */
        .quiz-add-btn { width: 50px; background: var(--card); border: 1px solid var(--border); color: var(--sub-text); border-radius: 10px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .quiz-add-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* é”™é¢˜æœ¬ */
        .list-container { width: 100%; max-width: 600px; display: grid; gap: 10px; margin-bottom: 60px; }
        .list-item { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .list-item.selected { border-color: var(--accent); background: rgba(187, 134, 252, 0.1); }
        .checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent); }
        
        /* æ‰¹é‡æ“ä½œæ  */
        .bulk-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 10px 20px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; gap: 10px; z-index: 100; border: 1px solid var(--accent); display: none; }
        .bulk-actions.show { display: flex; }
        .bulk-btn { background: none; border: none; color: var(--text); cursor: pointer; font-size: 14px; padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; }
        .bulk-btn:hover { background: var(--bg); color: var(--accent); }

        /* æ’è¡Œæ¦œ */
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); color: var(--sub-text); font-size: 14px; }
        .rank-item.me { color: var(--accent); font-weight: bold; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 90%; max-width: 400px; border-radius: 15px; padding: 25px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; text-align: center;}
        .book-btn { display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px; text-align: left; cursor: pointer; font-size: 16px; font-weight: 600; }
        
        .login-input { width: 100%; padding: 15px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 18px; margin-bottom: 20px; text-align: center; outline: none; }
        .login-input:focus { border-color: var(--accent); }

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300; }
        .toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>

    <!-- 1. ç™»å½•/æ³¨å†Œå¼¹çª— (é¦–å±) -->
    <div class="modal-overlay" id="login-modal" style="display:flex;">
        <div class="modal-content">
            <h1 style="color:var(--accent); margin-bottom:10px">THE FORGE</h1>
            <p style="color:var(--sub-text); margin-bottom:30px">ä½ çš„å¤šåŠŸèƒ½äº‘ç«¯è¯æ±‡åº“</p>
            
            <input type="text" id="username-input" class="login-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§° (ID)">
            <button class="btn-control" style="background:var(--success); color:black" onclick="handleLogin()">ğŸš€ å¼€å§‹å­¦ä¹ </button>
            <p style="margin-top:20px; font-size:12px; color:var(--sub-text)">*æœ¬åœ°å¤šç”¨æˆ·ç³»ç»Ÿï¼Œåˆ‡æ¢IDå³å¯åˆ‡æ¢è¿›åº¦</p>
        </div>
    </div>

    <!-- 2. é€‰ä¹¦å¼¹çª— -->
    <div class="modal-overlay" id="book-modal" style="display:none;">
        <div class="modal-content">
            <h2 style="color:var(--text); margin-bottom: 20px;">ğŸ“š æ¬¢è¿, <span id="welcome-user"></span></h2>
            <p style="color:var(--sub-text); margin-bottom: 20px;">è¯·é€‰æ‹©ä»Šæ—¥æŒ‘æˆ˜çš„è¯ä¹¦</p>
            <div id="book-list"><p style="color:red">åˆå§‹åŒ–ä¸­...</p></div>
        </div>
    </div>

    <!-- æ‰‹æœºé¡¶éƒ¨ -->
    <div class="mobile-header">
        <div class="logo">âš¡ THE FORGE</div>
        <div style="font-size: 24px; cursor: pointer;" onclick="toggleStats()">ğŸ“Š</div>
    </div>

    <!-- å·¦ä¾§å¯¼èˆª -->
    <div class="sidebar">
        <div class="logo desktop-only">âš¡ THE FORGE</div>
        
        <div class="user-card" onclick="location.reload()">
            <div class="user-avatar" id="sidebar-avatar">U</div>
            <div style="font-size:14px; color:var(--text); font-weight:bold" id="sidebar-username">User</div>
        </div>

        <div class="nav-item active" onclick="switchTab('learn')"><span class="nav-icon">ğŸ </span><span class="nav-text">èƒŒå•è¯</span></div>
        <div class="nav-item" onclick="switchTab('wrong')"><span class="nav-icon">ğŸ““</span><span class="nav-text">é”™é¢˜æœ¬</span></div>
        <div class="nav-item" onclick="switchTab('quiz')"><span class="nav-icon">ğŸ¯</span><span class="nav-text">é€‰è¯</span></div>
        <div class="nav-item" onclick="switchTab('cloze')"><span class="nav-icon">ğŸ§©</span><span class="nav-text">å¡«ç©º</span></div>
        
        <div class="section-title">ğŸŒ ä¼ é€é—¨</div>
        <div class="nav-item" onclick="window.open('https://www.chinadaily.com.cn/','_blank')"><span class="nav-icon">ğŸ“°</span><span class="nav-text">ChinaDaily</span></div>
        <div class="nav-item" onclick="window.open('https://www.bbc.co.uk/learningenglish/','_blank')"><span class="nav-icon">ğŸ‡¬ğŸ‡§</span><span class="nav-text">BBC English</span></div>
        <div class="nav-item" onclick="window.open('https://www.etymonline.com/','_blank')"><span class="nav-icon">ğŸŒ±</span><span class="nav-text">è¯æºå­—å…¸</span></div>

        <div class="section-title">è®¾ç½®</div>
        <div class="nav-item" onclick="toggleTheme()"><span class="nav-icon">â˜€ï¸</span><span class="nav-text">ä¸»é¢˜</span></div>
        <div class="nav-item" onclick="resetProgress()"><span class="nav-icon">ğŸ”„</span><span class="nav-text">æ¢ä¹¦/æ³¨é”€</span></div>
    </div>

    <!-- ä¸»åŒºåŸŸ -->
    <div class="main-area">
        
        <!-- èƒŒè¯ -->
        <div id="section-learn" class="page-section active">
            <div style="width:100%; max-width:500px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <div style="color: var(--sub-text); font-size: 14px;">
                    <span id="learn-mode-tag" style="background:var(--accent); color:black; padding:2px 6px; border-radius:4px; font-size:10px; display:none; margin-right:5px">é”™é¢˜å¤ä¹ ä¸­</span>
                    ä¹¦å: <span id="current-book-name" style="color:var(--accent); font-weight:bold">...</span>
                </div>
                <button id="exit-mistake-btn" onclick="exitMistakeMode()" style="display:none; background:var(--bg); border:1px solid var(--sub-text); color:var(--text); padding:5px 10px; border-radius:15px; font-size:12px; cursor:pointer;">â†© é€€å‡ºå¤ä¹ </button>
            </div>
            
            <div class="card-container" onclick="flipCard()">
                <div class="card-inner">
                    <div class="card-face card-front">
                        <div class="word-text" id="card-word">Loading...</div>
                        <div class="phonetic" id="card-phonetic"> </div>
                        <button onclick="event.stopPropagation(); playAudio()" style="background:none; border:1px solid var(--accent); color:var(--accent); padding:5px 15px; border-radius:20px; cursor:pointer;">ğŸ”Š å‘éŸ³</button>
                    </div>
                    <div class="card-face card-back">
                        <div class="meaning" id="card-meaning">...</div>
                        <div class="sentence" id="card-sentence">...</div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn-control" style="background:var(--danger)" onclick="rateWord(0)">ğŸ˜© è®°ä¸ä½</button>
                <button class="btn-control" style="background:var(--success)" onclick="rateWord(1)">ğŸ˜ è®°ä½äº†</button>
            </div>
        </div>

        <!-- é”™é¢˜æœ¬ -->
        <div id="section-wrong" class="page-section">
            <h2 style="color:var(--text); margin-bottom: 20px;">ğŸ““ é”™é¢˜æœ¬</h2>
            <div style="width:100%; max-width:600px; display:flex; justify-content:space-between; margin-bottom:10px; color:var(--sub-text); font-size:12px">
                <label style="display:flex; align-items:center; gap:5px; cursor:pointer">
                    <input type="checkbox" onchange="toggleSelectAll(this)"> å…¨é€‰
                </label>
                <span id="selected-count">å·²é€‰: 0</span>
            </div>
            <div class="list-container" id="wrong-container"></div>
            
            <div class="bulk-actions" id="bulk-bar">
                <button class="bulk-btn" onclick="bulkReview()">ğŸš€ å¤ä¹ </button>
                <button class="bulk-btn" onclick="openAIMenu()">ğŸ¤– AIå‡ºé¢˜</button>
                <button class="bulk-btn" style="color:var(--danger)" onclick="bulkDelete()">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>

            <!-- AI é€‰é¡¹èœå• (å†…åµŒ) -->
            <div id="ai-options" style="display:none; background:var(--card); border:1px solid var(--border); padding:15px; border-radius:10px; position:fixed; bottom:80px; z-index:110;">
                <div style="margin-bottom:10px; font-weight:bold">AI é¢˜æºé€‰æ‹©ï¼š</div>
                <label style="display:block; margin-bottom:5px"><input type="radio" name="ai-source" value="selected" checked> æ¥è‡ªå‹¾é€‰çš„é”™é¢˜</label>
                <label style="display:block; margin-bottom:15px"><input type="radio" name="ai-source" value="random"> ä»å½“å‰ä¹¦æœ¬éšæœº (20è¯)</label>
                <button class="btn-control" style="background:var(--accent); padding:5px; font-size:14px" onclick="generateAIPrompt()">ç”Ÿæˆ Prompt</button>
            </div>
        </div>

        <!-- Quiz (æ–°ç‰ˆ) -->
        <div id="section-quiz" class="page-section">
            <h2 style="margin-bottom:20px; color:var(--sub-text)">ğŸ¯ é€‰è¯æµ‹è¯•</h2>
            <div class="quiz-container">
                <div class="quiz-question" id="quiz-word">Word</div>
                <div class="quiz-options" id="quiz-options"></div>
                <button class="btn-control" style="background:var(--accent); margin-top:20px;" onclick="generateQuiz()">â¡ï¸ ä¸‹ä¸€é¢˜</button>
            </div>
        </div>

        <!-- å®Œå½¢å¡«ç©º -->
        <div id="section-cloze" class="page-section">
            <h2 style="margin-bottom:20px; color:var(--sub-text)">ğŸ§© è¯­å¢ƒå¡«ç©º</h2>
            <div class="quiz-container">
                <div class="quiz-question" id="cloze-sentence" style="font-size:20px; text-align:left; background:var(--card); padding:20px; border-radius:10px; border:1px solid var(--border)">Loading...</div>
                <div class="quiz-options" id="cloze-options" style="margin-top:20px"></div>
            </div>
        </div>

    </div>

    <!-- å³ä¾§é¢æ¿ -->
    <div class="stats-panel" id="stats-panel">
        <div style="display: flex; justify-content: space-between;">
            <h3 style="color:var(--text)">å®æ—¶æ¦œå•</h3>
            <span style="font-size: 24px; cursor: pointer;" onclick="toggleStats()">âœ•</span>
        </div>
        <div id="leaderboard" style="margin-top:20px"></div>
        
        <div style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px">
            <div style="color:var(--sub-text); font-size:12px">æˆ‘çš„èƒŒè¯æ•°</div>
            <div class="stat-val" style="color:var(--success)" id="study-count">0</div>
        </div>
    </div>

    <div class="toast" id="toast">æç¤º</div>

    <script>
        // === 1. é…ç½® ===
        const books = [
            { name: "åˆä¸­è¯æ±‡", file: "json/1-åˆä¸­-é¡ºåº.json" },
            { name: "é«˜ä¸­è¯æ±‡", file: "json/2-é«˜ä¸­-é¡ºåº.json" },
            { name: "å››çº§è¯æ±‡", file: "json/3-CET4-é¡ºåº.json" },
            { name: "å…­çº§è¯æ±‡", file: "json/4-CET6-é¡ºåº.json" },
            { name: "è€ƒç ”è¯æ±‡", file: "json/5-è€ƒç ”-é¡ºåº.json" },
            { name: "æ‰˜ç¦è¯æ±‡", file: "json/6-æ‰˜ç¦-é¡ºåº.json" },
            { name: "SATè¯æ±‡", file: "json/7-SAT-é¡ºåº.json" }
        ];

        let currentUser = null; // å½“å‰ç”¨æˆ·ID
        let fullBookQueue = [];
        let currentQueue = [];
        let currentIndex = 0;
        let currentBookName = "";
        let wrongWords = [];
        let studyCount = 0;
        let isMistakeMode = false;
        let selectedMistakeIndices = new Set();
        let isLightMode = localStorage.getItem('forge_theme') === 'light';

        // === 2. è´¦å·ç³»ç»Ÿé€»è¾‘ ===
        function handleLogin() {
            const input = document.getElementById('username-input');
            const name = input.value.trim();
            if(!name) return alert("è¯·è¾“å…¥åå­—");
            
            currentUser = name;
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('sidebar-username').textContent = currentUser;
            document.getElementById('sidebar-avatar').textContent = currentUser[0].toUpperCase();
            document.getElementById('welcome-user').textContent = currentUser;

            // åŠ è½½ç”¨æˆ·æ•°æ®
            loadUserData();
        }

        function loadUserData() {
            // ä» localStorage è¯»å–å¸¦ç”¨æˆ·å‰ç¼€çš„æ•°æ®
            wrongWords = getLocal('wrong_words') || [];
            studyCount = getLocal('study_count') || 0;
            
            // æ£€æŸ¥è¿›åº¦
            const progress = getLocal('progress');
            if(progress && progress.queue && progress.queue.length > 0) {
                currentQueue = progress.queue;
                fullBookQueue = progress.fullQueue || progress.queue;
                currentIndex = progress.index;
                currentBookName = progress.bookName;
                
                document.getElementById('current-book-name').textContent = currentBookName;
                document.getElementById('book-modal').style.display = 'none';
                loadCard(currentIndex);
                showToast(`æ¬¢è¿å›æ¥, ${currentUser}`);
            } else {
                // æ–°ç”¨æˆ·é€‰ä¹¦
                initBookSelector();
                document.getElementById('book-modal').style.display = 'flex';
            }
            updateWrongUI();
            updateLeaderboard();
        }

        // æ•°æ®å­˜å‚¨è¾…åŠ©å‡½æ•° (å¸¦ç”¨æˆ·å‰ç¼€)
        function getLocal(key) {
            return JSON.parse(localStorage.getItem(`${currentUser}_${key}`));
        }
        function setLocal(key, val) {
            localStorage.setItem(`${currentUser}_${key}`, JSON.stringify(val));
        }

        // === 3. åˆå§‹åŒ– ===
        window.onload = function() {
            if(isLightMode) document.body.classList.add('light-mode');
        };

        function initBookSelector() {
            const list = document.getElementById('book-list');
            list.innerHTML = '';
            books.forEach(book => {
                const btn = document.createElement('button');
                btn.className = 'book-btn';
                btn.textContent = book.name;
                btn.onclick = () => loadBook(book);
                list.appendChild(btn);
            });
        }

        function loadBook(book) {
            showToast("åŠ è½½ä¸­...");
            fetch(book.file).then(res => res.json()).then(data => {
                fullBookQueue = cleanData(data);
                fullBookQueue.sort(() => Math.random() - 0.5);
                currentQueue = [...fullBookQueue];
                currentIndex = 0;
                currentBookName = book.name;
                isMistakeMode = false;
                
                setLocal('progress', {
                    bookName: currentBookName,
                    queue: currentQueue,
                    fullQueue: fullBookQueue,
                    index: currentIndex
                });
                
                updateLearnUI();
                document.getElementById('book-modal').style.display = 'none';
                loadCard(0);
            }).catch(e => alert("æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„"));
        }

        function cleanData(data) {
            return data.map(item => ({
                word: item.word,
                phonetic: item.phonetic || "",
                meaning: (item.translations || []).map(t => t.translation).join('; '),
                sentence: (item.phrases && item.phrases[0]) ? `${item.phrases[0].phrase}<br>${item.phrases[0].translation}` : "No sentence."
            }));
        }

        // === 4. æ ¸å¿ƒåŠŸèƒ½ ===
        function loadCard(index) {
            if (!currentQueue[index]) return;
            const data = currentQueue[index];
            const card = document.querySelector('.card-container');
            card.classList.remove('flipped');
            
            document.getElementById('card-word').textContent = data.word;
            document.getElementById('card-phonetic').textContent = data.phonetic;
            document.getElementById('card-meaning').innerHTML = data.meaning;
            document.getElementById('card-sentence').innerHTML = data.sentence;
        }

        function flipCard() {
            document.querySelector('.card-container').classList.toggle('flipped');
        }

        function rateWord(score) {
            if (score === 0) {
                const w = currentQueue[currentIndex];
                if (!wrongWords.find(cw => cw.word === w.word)) {
                    wrongWords.push(w);
                    setLocal('wrong_words', wrongWords);
                    updateWrongUI();
                }
            }
            
            studyCount++;
            setLocal('study_count', studyCount);
            document.getElementById('study-count').textContent = studyCount;
            updateLeaderboard(); // å®æ—¶æ›´æ–°æ’å

            currentIndex++;
            if(!isMistakeMode) setLocal('progress', {
                bookName: currentBookName,
                queue: currentQueue,
                fullQueue: fullBookQueue,
                index: currentIndex
            });

            if (currentIndex >= currentQueue.length) {
                alert("æœ¬è½®ç»“æŸ");
                if(isMistakeMode) exitMistakeMode();
                else {
                    currentQueue.sort(() => Math.random() - 0.5);
                    currentIndex = 0;
                    loadCard(0);
                }
            } else {
                loadCard(currentIndex);
            }
        }

        // === 5. Quiz ä¿®æ­£ (å¸¦å³ä¾§åŠ å·) ===
        function generateQuiz() {
            if(fullBookQueue.length < 4) return;
            const correct = fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)];
            let options = [correct];
            while(options.length < 4) {
                let r = fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-word').textContent = correct.word;
            const container = document.getElementById('quiz-options');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const row = document.createElement('div');
                row.className = 'quiz-option-row';
                
                // é€‰é¡¹æŒ‰é’®
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';
                btn.innerHTML = `<span>${opt.meaning.split(';')[0]}</span><span class="reveal-text" style="display:none;font-size:12px;opacity:0.7">(${opt.word})</span>`;
                btn.onclick = () => {
                    document.querySelectorAll('.reveal-text').forEach(e => e.style.display = 'inline');
                    if(opt === correct) btn.classList.add('correct');
                    else {
                        btn.classList.add('wrong');
                        // é«˜äº®æ­£ç¡®
                        Array.from(container.children).forEach(r => {
                            if(r.firstChild.innerHTML.includes(correct.word)) r.firstChild.classList.add('correct');
                        });
                    }
                };

                // åŠ å·æŒ‰é’®
                const addBtn = document.createElement('button');
                addBtn.className = 'quiz-add-btn';
                addBtn.innerHTML = '+';
                addBtn.onclick = () => addToMistakeDirectly(opt);

                row.appendChild(btn);
                row.appendChild(addBtn);
                container.appendChild(row);
            });
        }

        function addToMistakeDirectly(wordObj) {
            if (!wrongWords.find(w => w.word === wordObj.word)) {
                wrongWords.push(wordObj);
                setLocal('wrong_words', wrongWords);
                updateWrongUI();
                showToast(`å·²å°† ${wordObj.word} åŠ å…¥é”™é¢˜`);
            } else {
                showToast("å·²åœ¨é”™é¢˜æœ¬ä¸­");
            }
        }

        // === 6. AI åŠŸèƒ½ (æ”¯æŒéšæœº/é€‰è¯) ===
        function openAIMenu() {
            const menu = document.getElementById('ai-options');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function generateAIPrompt() {
            const source = document.querySelector('input[name="ai-source"]:checked').value;
            let targetWords = [];

            if(source === 'selected') {
                targetWords = wrongWords.filter((_, i) => selectedMistakeIndices.has(i)).map(w => w.word);
                if(targetWords.length === 0) return alert("è¯·å…ˆåœ¨ä¸Šæ–¹å‹¾é€‰é”™é¢˜");
            } else {
                // éšæœºæŠ½å– 20 ä¸ª
                if(fullBookQueue.length === 0) return alert("è¯·å…ˆåŠ è½½ä¸€æœ¬è¯ä¹¦");
                for(let i=0; i<20; i++) {
                    targetWords.push(fullBookQueue[Math.floor(Math.random() * fullBookQueue.length)].word);
                }
            }

            const prompt = `æˆ‘æ­£åœ¨å­¦ä¹  ${currentBookName}ã€‚è¯·åˆ©ç”¨ä»¥ä¸‹å•è¯ä¸ºæˆ‘ç”Ÿæˆä¸€ç¯‡è‹±è¯­é˜…è¯»ç†è§£é¢˜ï¼ˆåŒ…å«å®Œå½¢å¡«ç©ºæˆ–é€‰æ‹©é¢˜ï¼‰ï¼Œè¦æ±‚æ–‡ç« é€šé¡ºï¼Œéš¾åº¦é€‚ä¸­ï¼Œå¹¶é™„å¸¦ç­”æ¡ˆå’Œè§£æï¼š\n\n${targetWords.join(', ')}`;

            navigator.clipboard.writeText(prompt).then(() => {
                alert("Prompt å·²å¤åˆ¶ï¼\nè¯·å» AI åŠ©æ‰‹å¤„ç²˜è´´ã€‚\n\nåŒ…å«å•è¯ï¼š" + targetWords.length + "ä¸ª");
                document.getElementById('ai-options').style.display = 'none';
            });
        }

        // === 7. æ’è¡Œæ¦œ (æ¨¡æ‹Ÿå¤šç”¨æˆ·) ===
        function updateLeaderboard() {
            const board = document.getElementById('leaderboard');
            board.innerHTML = '';
            
            // æ¨¡æ‹Ÿæ•°æ® + çœŸå®æ•°æ®
            let ranks = [
                { name: currentUser, count: studyCount } // ä½ çš„çœŸå®æ•°æ®
            ];
            
            // è¯»å–æœ¬åœ°å…¶ä»–ç”¨æˆ·æ•°æ® (å¦‚æœæœ‰)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.endsWith('_study_count')) {
                    const uName = key.replace('_study_count', '');
                    if (uName !== currentUser) {
                        ranks.push({ name: uName, count: parseInt(localStorage.getItem(key)) });
                    }
                }
            }

            // æ’åº
            ranks.sort((a, b) => b.count - a.count);

            ranks.forEach((r, i) => {
                const div = document.createElement('div');
                div.className = `rank-item ${r.name === currentUser ? 'me' : ''}`;
                div.innerHTML = `<span>#${i+1} ${r.name}</span><span>${r.count} è¯</span>`;
                board.appendChild(div);
            });
        }

        // === é€šç”¨é€»è¾‘ ===
        function exitMistakeMode() {
            const saved = getLocal('progress');
            currentQueue = saved.queue;
            currentIndex = saved.index;
            isMistakeMode = false;
            updateLearnUI();
            loadCard(currentIndex);
            showToast("å›åˆ°æ­£å¸¸æ¨¡å¼");
        }

        function updateLearnUI() {
            const tag = document.getElementById('learn-mode-tag');
            const btn = document.getElementById('exit-mistake-btn');
            if(isMistakeMode) { tag.style.display = 'inline-block'; btn.style.display = 'block'; }
            else { tag.style.display = 'none'; btn.style.display = 'none'; }
        }

        function updateWrongUI() {
            const container = document.getElementById('wrong-container');
            container.innerHTML = '';
            wrongWords.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                if(selectedMistakeIndices.has(idx)) div.classList.add('selected');
                div.innerHTML = `
                    <input type="checkbox" class="checkbox" ${selectedMistakeIndices.has(idx) ? 'checked' : ''} onchange="toggleSelect(${idx})">
                    <div style="flex:1" onclick="toggleSelect(${idx})">
                        <div style="font-weight:bold">${item.word}</div>
                        <div style="font-size:12px;color:var(--sub-text)">${item.meaning.split(';')[0]}</div>
                    </div>
                `;
                container.appendChild(div);
            });
            const bar = document.getElementById('bulk-bar');
            if(selectedMistakeIndices.size > 0) bar.classList.add('show');
            else bar.classList.remove('show');
            document.getElementById('selected-count').textContent = `å·²é€‰: ${selectedMistakeIndices.size}`;
        }

        function toggleSelect(idx) {
            if(selectedMistakeIndices.has(idx)) selectedMistakeIndices.delete(idx);
            else selectedMistakeIndices.add(idx);
            updateWrongUI();
        }

        function toggleSelectAll(cb) {
            if(cb.checked) wrongWords.forEach((_, i) => selectedMistakeIndices.add(i));
            else selectedMistakeIndices.clear();
            updateWrongUI();
        }

        function bulkDelete() {
            wrongWords = wrongWords.filter((_, i) => !selectedMistakeIndices.has(i));
            selectedMistakeIndices.clear();
            setLocal('wrong_words', wrongWords);
            updateWrongUI();
        }

        function bulkReview() {
            if(selectedMistakeIndices.size === 0) return;
            currentQueue = wrongWords.filter((_, i) => selectedMistakeIndices.has(i));
            currentQueue.sort(() => Math.random() - 0.5);
            currentIndex = 0;
            isMistakeMode = true;
            updateLearnUI();
            switchTab('learn');
            loadCard(0);
        }

        function playAudio() {
            const txt = currentQueue[currentIndex]?.word;
            if(txt) window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
        }

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            if(id === 'quiz') generateQuiz();
        }

        function toggleTheme() {
            isLightMode = !isLightMode;
            document.body.classList.toggle('light-mode', isLightMode);
            localStorage.setItem('forge_theme', isLightMode ? 'light' : 'dark');
        }

        function toggleStats() {
            document.getElementById('stats-panel').classList.toggle('open');
        }

        function showToast(text) {
            const t = document.getElementById('toast');
            t.textContent = text; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function resetProgress() {
            if(confirm("æ³¨é”€å½“å‰è´¦æˆ·å¹¶é‡ç½®ï¼Ÿ")) location.reload();
        }
    </script>
</body>
</html>